<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Solicitud de Permiso de Ausencia</title>
  <link rel="stylesheet" href="/css/core.css" />


</head>
<body>
  <nav class="layout-navbar navbar navbar-expand-lg bg-white">
    <div class="container-fluid">
      <span class="navbar-brand text-primary fw-bold">Panel del Médico</span>
    </div>
  </nav>

  <div class="container mt-5">
    <h1 class="text-primary mb-4">Solicitud de Permiso de Ausencia</h1>

    <form id="permiso-form">
      <input type="hidden" id="MEDICO_id_med" value="1" /> <!-- ID del médico conectado -->

      <div class="mb-3">
        <label for="tipo" class="form-label">Tipo de Permiso</label>
        <input type="text" class="form-control" id="tipo" placeholder="Ej: Vacaciones, Licencia médica" required />
      </div>

      <div class="mb-3">
        <label for="fecha_inicio" class="form-label">Fecha de Inicio</label>
        <input type="date" class="form-control" id="fecha_inicio" required />
      </div>

      <div class="mb-3">
        <label for="fecha_fin" class="form-label">Fecha de Fin</label>
        <input type="date" class="form-control" id="fecha_fin" required />
      </div>

      <button type="submit" class="btn btn-primary">Enviar Solicitud</button>
    </form>

    <div id="mensaje" class="mt-3"></div>

    <h2 class="text-primary mt-5">Permisos solicitados</h2>
    <div class="table-responsive">
      <table class="table table-striped table-bordered mt-3" id="tabla-permisos">
        <thead class="table-primary">
          <tr>
            <th>ID</th>
            <th>Tipo</th>
            <th>Fecha Inicio</th>
            <th>Fecha Fin</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filas dinámicas -->
        </tbody>
      </table>
    </div>
  </div>

<!-- ... encabezado HTML igual ... -->

<script>
  function cargarPermisos() {
    const idMedico = parseInt(document.getElementById('MEDICO_id_med').value);

    fetch('http://localhost:3000/permisos')  // ✅ RUTA CORRECTA PARA OBTENER PERMISOS
      .then(response => response.json())
      .then(data => {
        const tbody = document.getElementById('tabla-permisos').querySelector('tbody');
        tbody.innerHTML = '';

        const permisosMedico = data.filter(p => p.MEDICO_ID_MED === idMedico);

        if (permisosMedico.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="text-center">No hay permisos registrados.</td></tr>';
          return;
        }

        permisosMedico.forEach(p => {
          const fila = `
            <tr>
              <td>${p.ID_PERMISO}</td>
              <td>${p.TIPO}</td>
              <td>${p.FECHA_INICIO}</td>
              <td>${p.FECHA_FIN}</td>
              <td>${p.ESTADO}</td>
            </tr>
          `;
          tbody.innerHTML += fila;
        });
      })
      .catch(error => {
        console.error('Error al cargar permisos:', error);
      });
  }

  document.getElementById('permiso-form').addEventListener('submit', function (e) {
    e.preventDefault();

    const data = {
      id_permiso: Date.now(), // ID único generado por timestamp
      tipo: document.getElementById('tipo').value,
      fecha_inicio: document.getElementById('fecha_inicio').value,
      fecha_fin: document.getElementById('fecha_fin').value,
      estado: 'Pendiente',
      MEDICO_id_med: parseInt(document.getElementById('MEDICO_id_med').value)
    };

    fetch('http://localhost:3000/permisos', {  // ✅ RUTA CORRECTA PARA CREAR PERMISO
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    })
      .then(response => {
        if (response.ok) {
          document.getElementById('mensaje').innerHTML =
            '<div class="alert alert-success">✅ Solicitud enviada exitosamente.</div>';
          document.getElementById('permiso-form').reset();
          cargarPermisos(); // Refrescar tabla
        } else {
          document.getElementById('mensaje').innerHTML =
            '<div class="alert alert-danger">❌ Error al enviar la solicitud.</div>';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        document.getElementById('mensaje').innerHTML =
          '<div class="alert alert-danger">❌ Error al enviar la solicitud.</div>';
      });
  });

  window.addEventListener('DOMContentLoaded', cargarPermisos);
</script>

</body>
</html>
